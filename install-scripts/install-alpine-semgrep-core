#! /usr/bin/env bash
#
# Build the semgrep-core statically-linked against musl, on alpine linux,
# with opam pre-installed.
#
# This script assumes we're at the root of the checked-out semgrep repository.
#
set -eu

# Sanity check
if [[ ! -e /etc/alpine-release ]]; then
  echo "Error: This doesn't look like an Alpine container." >&2
  exit 1
fi

echo "Install missing packages"
sudo apk add --no-cache perl m4

echo "Install submodules"
git submodule update --init --recursive

echo "Install ocaml-tree-sitter"
eval $(opam env --root /home/opam/.opam --set-root)
./install-scripts/install-ocaml-tree-sitter

echo "Install pfff"
opam install -y ./pfff

echo "Install semgrep-core"
(
  cd semgrep-core
  opam install --deps-only -y .
  make all
  make install
)

echo "Copy semgrep-core to artifacts"
mkdir -p artifacts
cp ./semgrep-core/_build/default/bin/Main.exe artifacts/semgrep-core
